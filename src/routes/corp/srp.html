<template>
  <div class="container">
    <div class="row">
    </div>
    <div class="row">
      <div class="col s9">
        <ul md-tabs class="z-depth-1">
          <li><a class="active" href="#tab1">Personal Not Submitted</a></li>
          <li><a href="#tab2">Personal Submitted</a></li>
          <li><a href="#tab3">All Submitted</a></li>
        </ul>
        <div id="tab1" class="z-depth-1">
          <md-collection view-model.ref="personal">
            <md-collection-item repeat.for="lossmail of lossmails"
                                class="avatar ${ personal_selector.isSelected ? 'selected' : '' }">
              <md-collection-selector view-model.ref="personal_selector" item.bind="lossmail"
                                      md-on-selection-changed.delegate="personal_prices()">
                <img src="https://imageserver.eveonline.com/Render/${lossmail.ship_item_id}_64.png"
                     alt="${lossmail.ship_name}" class="circle md-collection-selector__hover">
              </md-collection-selector>
              <span class="accent-text title">${lossmail.ship_name} @ ${lossmail.solar_system_name}</span>
              <p>
                ${lossmail.kill_time | date}
                <br/>
                ${lossmail.ship_group_name} : ${lossmail.lower_ship_group_name}
                <br/>
                Payout: <b>${lossmail.srp_total | iskFormat}</b>
                <br/>
                <a href="https://zkillboard.com/kill/${lossmail.id}" target="_blank">ZKillboard Link</a>
              </p>
            </md-collection-item>
          </md-collection>
        </div>
        <div id="tab2" class="z-depth-1">
          <h3>Work In Progress</h3>
        </div>
        <div id="tab3" class="z-depth-1">
          <md-collection view-model.ref="all"
                         if.bind="socket.info.permissions.get('srp_approve') || socket.super_admin">
            <md-collection-item repeat.for="[lossmail_id, lossmail] of changefeeds.lossmails_all"
                                class="avatar ${ all_selector.isSelected ? 'selected' : '' }">
              <md-collection-selector view-model.ref="all_selector" item.bind="lossmail"
                                      md-on-selection-changed.delegate="all_selection($event)">
                <img src="https://imageserver.eveonline.com/Render/${lossmail.ship_item_id}_64.png"
                     alt="${lossmail.ship_name}" class="circle md-collection-selector__hover">
              </md-collection-selector>
              <span class="accent-text title">${lossmail.ship_name} @ ${lossmail.solar_system_name}</span>
              <p>
                ${lossmail.kill_time | date}
                <br/>
                ${lossmail.ship_group_name} : ${lossmail.lower_ship_group_name}
                <br/>
                Payout: <b>${lossmail.srp_total | iskFormat}</b>
                <br/>
                <a href="https://zkillboard.com/kill/${lossmail.id}" target="_blank">ZKillboard Link</a>
              </p>
            </md-collection-item>
          </md-collection>
          <md-collection if.bind="!(socket.info.permissions.get('srp_approve') || socket.super_admin)">
            <md-collection-item repeat.for="[lossmail_id, lossmail] of changefeeds.lossmails_all"
                                class="accent-text avatar">
              <img src="https://imageserver.eveonline.com/Render/${lossmail.ship_item_id}_64.png"
                   alt="${lossmail.ship_name}" class="circle">
              <span class="accent-text title">${lossmail.ship_name} @ ${lossmail.solar_system_name}</span>
              <p>
                ${lossmail.kill_time | date}
                <br/>
                ${lossmail.ship_group_name} : ${lossmail.lower_ship_group_name}
                <br/>
                Payout: <b>${lossmail.srp_total | iskFormat}</b>
                <br/>
                <a href="https://zkillboard.com/kill/${lossmail.id}" target="_blank">ZKillboard Link</a>
              </p>
            </md-collection-item>
          </md-collection>
        </div>
      </div>
      <div class="col s3">
        <div md-pushpin="top: 80; offset: 80;">
          <md-card md-title="Selected Lossmails">
            <md-collection>
              <md-collection-item class="accent-text" repeat.for="lossmail of personal_selected">
                ${lossmail.ship_name} @ ${lossmail.solar_system_name}
              </md-collection-item>
            </md-collection>
          </md-card>
          <md-card>
            <a md-button md-modal-trigger href="#help">Help</a>
            <button click.delegate="refresh()" md-button show.bind="!updating_losses">Refresh Lossmails</button>
            <button md-button="disabled:true" show.bind="updating_losses">Refreshing...</button>
            <select md-select="label: SRP Type" value.two-way="srp_type" change.delegate="personal_prices()">
              <option repeat.for='type of srp_types' value.bind="type">${type}</option>
            </select>
            <br/>
            Total: ${personal_srp_total | iskFormat}
            <br/>
            <br/>
            <a md-button='disabled:true' show.bind="personal_selected.length === 0">Select</a>
            <a md-button md-modal-trigger href="#submit" show.bind="personal_selected.length !== 0">Select</a>
          </md-card>
        </div>
      </div>
    </div>
  </div>
  <div id="submit" class="modal" ref="submit_modal">
    <div class="modal-content">
      <div class="row">
        <table>
          <thead>
          <tr>
            <th>Ship</th>
            <th>Ship Group</th>
            <th>Market Price</th>
            <th>Multiplier</th>
            <th>SRP Price</th>
          </tr>
          </thead>
          <tbody>
          <tr repeat.for="lossmail of personal_selected">
            <td>${lossmail.ship_name}</td>
            <td>${lossmail.ship_group_name} : ${lossmail.lower_ship_group_name}</td>
            <td>${lossmail.srp_base_price | iskFormat}</td>
            <td>${lossmail.multiplier}</td>
            <td>${lossmail.srp_total | iskFormat}</td>
          </tr>
          <tr>
            <td>Total</td>
            <td></td>
            <td>${personal_base_price | iskFormat}</td>
            <td></td>
            <td><b>${personal_srp_total | iskFormat}</b></td>
          </tr>
          </tbody>
        </table>
        <div class="row">
          <label>SRP Type: </label>
          <md-radio repeat.for='type of srp_types' md-name="srp-type" md-value.bind="type"
                    md-checked.bind="$parent.srp_type" change.delegate="personal_prices()">${type}
          </md-radio>
        </div>
        <div class="row">
          <select md-select="label: Pay To" value.bind="reimburse_to">
            <option repeat.for='character of changefeeds.associated_characters' value.bind="character.character_name">${character.character_name}</option>
          </select>
        </div>
        <div class="row">
          <md-input
            md-label="AAR Link"
            md-validate="true"
            md-value.bind="aar & validate:rules">
          </md-input>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <a click.delegate="submit()" md-button="flat: true;" class="modal-action">Submit</a>
      <a md-button="flat: true;" class="modal-action modal-close">Cancel</a>
    </div>
  </div>
  <div id="help" class="modal">
    <div class="modal-content">
      <h3>Instructions</h3>
      <p>Click a ship icon to select it.</p>
      <p>You can batch-submit by selecting multiple ships at a time.</p>
      <p>Press the select button to bring up the form.</p>
    </div>
    <div class="modal-footer">
      <a md-button="flat: true;" class="modal-action modal-close">Close</a>
    </div>
  </div>
</template>
